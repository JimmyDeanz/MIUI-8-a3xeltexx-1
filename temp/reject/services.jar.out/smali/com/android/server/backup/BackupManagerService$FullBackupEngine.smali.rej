*** BackupManagerService$FullBackupEngine.smali	2017-10-30 11:17:50.575808055 +0100
--- BackupManagerService$FullBackupEngine.smali	2017-10-30 11:08:24.619224128 +0100
***************
*** 605,610 ****
      .local v4, "agent":Landroid/app/IBackupAgent;
      if-eqz v4, :cond_a
  
      const/4 v13, 0x0
  
      .local v13, "pipes":[Landroid/os/ParcelFileDescriptor;
--- 624,639 ----
      .local v4, "agent":Landroid/app/IBackupAgent;
      if-eqz v4, :cond_a
  
+     move-object/from16 v0, p0
+ 
+     iget-object v2, v0, Lcom/android/server/backup/BackupManagerService$FullBackupEngine;->mOutputFile:Landroid/os/ParcelFileDescriptor;
+ 
+     invoke-virtual {v2}, Landroid/os/ParcelFileDescriptor;->getFd()I
+ 
+     move-result v2
+ 
+     invoke-static {v4, v2}, Lcom/android/server/backup/BackupManagerServiceInjector;->linkToDeath(Landroid/app/IBackupAgent;I)V
+ 
      const/4 v13, 0x0
  
      .local v13, "pipes":[Landroid/os/ParcelFileDescriptor;
***************
*** 754,767 ****
  
      iget-object v5, v0, Lcom/android/server/backup/BackupManagerService$FullBackupEngine;->mOutput:Ljava/io/OutputStream;
  
!     # invokes: Lcom/android/server/backup/BackupManagerService;->routeSocketDataToOutput(Landroid/os/ParcelFileDescriptor;Ljava/io/OutputStream;)V
!     invoke-static {v2, v3, v5}, Lcom/android/server/backup/BackupManagerService;->access$800(Lcom/android/server/backup/BackupManagerService;Landroid/os/ParcelFileDescriptor;Ljava/io/OutputStream;)V
      :try_end_1
      .catch Ljava/io/IOException; {:try_start_1 .. :try_end_1} :catch_0
      .catchall {:try_start_1 .. :try_end_1} :catchall_0
  
      :goto_2
      :try_start_2
      move-object/from16 v0, p0
  
      iget-object v2, v0, Lcom/android/server/backup/BackupManagerService$FullBackupEngine;->this$0:Lcom/android/server/backup/BackupManagerService;
--- 783,809 ----
  
      iget-object v5, v0, Lcom/android/server/backup/BackupManagerService$FullBackupEngine;->mOutput:Ljava/io/OutputStream;
  
!     move-object/from16 v0, p0
! 
!     iget-object v8, v0, Lcom/android/server/backup/BackupManagerService$FullBackupEngine;->mOutputFile:Landroid/os/ParcelFileDescriptor;
! 
!     invoke-virtual {v8}, Landroid/os/ParcelFileDescriptor;->getFd()I
! 
!     move-result v8
! 
!     invoke-static {v2, v3, v5, v8}, Lcom/android/server/backup/BackupManagerServiceInjector;->routeSocketDataToOutput(Lcom/android/server/backup/BackupManagerService;Landroid/os/ParcelFileDescriptor;Ljava/io/OutputStream;I)V
      :try_end_1
      .catch Ljava/io/IOException; {:try_start_1 .. :try_end_1} :catch_0
      .catchall {:try_start_1 .. :try_end_1} :catchall_0
  
      :goto_2
      :try_start_2
+     invoke-static {v4, v6}, Lcom/android/server/backup/BackupManagerServiceInjector;->needUpdateToken(Landroid/app/IBackupAgent;I)Z
+ 
+     move-result v2
+ 
+     if-eqz v2, :cond_2
+ 
      move-object/from16 v0, p0
  
      iget-object v2, v0, Lcom/android/server/backup/BackupManagerService$FullBackupEngine;->this$0:Lcom/android/server/backup/BackupManagerService;
***************
*** 850,855 ****
      .end local v13    # "pipes":[Landroid/os/ParcelFileDescriptor;
      :cond_4
      :goto_3
      invoke-direct/range {p0 .. p1}, Lcom/android/server/backup/BackupManagerService$FullBackupEngine;->tearDown(Landroid/content/pm/PackageInfo;)V
  
      return v14
--- 892,900 ----
      .end local v13    # "pipes":[Landroid/os/ParcelFileDescriptor;
      :cond_4
      :goto_3
+     invoke-static {v4}, Lcom/android/server/backup/BackupManagerServiceInjector;->unlinkToDeath(Landroid/app/IBackupAgent;)V
+ 
+     :goto_miui_0
      invoke-direct/range {p0 .. p1}, Lcom/android/server/backup/BackupManagerService$FullBackupEngine;->tearDown(Landroid/content/pm/PackageInfo;)V
  
      return v14
***************
*** 1088,1092 ****
  
      const/16 v14, -0x3eb
  
!     goto/16 :goto_3
  .end method
--- 1133,1137 ----
  
      const/16 v14, -0x3eb
  
!     goto/16 :goto_miui_0
  .end method
