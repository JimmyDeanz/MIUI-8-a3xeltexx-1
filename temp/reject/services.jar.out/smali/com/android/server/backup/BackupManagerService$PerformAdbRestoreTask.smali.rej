*** BackupManagerService$PerformAdbRestoreTask.smali	2017-10-30 11:17:50.511808411 +0100
--- BackupManagerService$PerformAdbRestoreTask.smali	2017-10-30 11:08:24.551224583 +0100
***************
*** 2517,2528 ****
      iget v6, v0, Landroid/content/pm/ApplicationInfo;->flags:I
  
      .local v6, "flags":I
      const v17, 0x8000
  
      and-int v17, v17, v6
  
      if-eqz v17, :cond_9
  
      iget-object v0, v12, Landroid/content/pm/PackageInfo;->applicationInfo:Landroid/content/pm/ApplicationInfo;
  
      move-object/from16 v17, v0
--- 2516,2544 ----
      iget v6, v0, Landroid/content/pm/ApplicationInfo;->flags:I
  
      .local v6, "flags":I
+     move-object/from16 v0, p0
+ 
+     iget-object v0, v0, Lcom/android/server/backup/BackupManagerService$PerformAdbRestoreTask;->mInputFile:Landroid/os/ParcelFileDescriptor;
+ 
+     move-object/from16 v17, v0
+ 
+     invoke-virtual/range {v17 .. v17}, Landroid/os/ParcelFileDescriptor;->getFd()I
+ 
+     move-result v17
+ 
+     invoke-static/range {v17 .. v17}, Lcom/android/server/backup/BackupManagerServiceInjector;->isForceAllowBackup(I)Z
+ 
+     move-result v17
+ 
+     if-nez v17, :cond_miui_4
+ 
      const v17, 0x8000
  
      and-int v17, v17, v6
  
      if-eqz v17, :cond_9
  
+     :cond_miui_4
      iget-object v0, v12, Landroid/content/pm/PackageInfo;->applicationInfo:Landroid/content/pm/ApplicationInfo;
  
      move-object/from16 v17, v0
***************
*** 4772,4777 ****
      check-cast v40, Lcom/android/server/backup/BackupManagerService$RestorePolicy;
  
      .local v40, "policy":Lcom/android/server/backup/BackupManagerService$RestorePolicy;
      sget-object v5, Lcom/android/server/backup/BackupManagerService$6;->$SwitchMap$com$android$server$backup$BackupManagerService$RestorePolicy:[I
  
      invoke-virtual/range {v40 .. v40}, Lcom/android/server/backup/BackupManagerService$RestorePolicy;->ordinal()I
--- 4788,4807 ----
      check-cast v40, Lcom/android/server/backup/BackupManagerService$RestorePolicy;
  
      .local v40, "policy":Lcom/android/server/backup/BackupManagerService$RestorePolicy;
+     move-object/from16 v0, v33
+ 
+     iget-wide v8, v0, Lcom/android/server/backup/BackupManagerService$FileMetadata;->size:J
+ 
+     move-object/from16 v0, p0
+ 
+     iget-object v5, v0, Lcom/android/server/backup/BackupManagerService$PerformAdbRestoreTask;->mInputFile:Landroid/os/ParcelFileDescriptor;
+ 
+     invoke-virtual {v5}, Landroid/os/ParcelFileDescriptor;->getFd()I
+ 
+     move-result v5
+ 
+     invoke-static {v8, v9, v5}, Lcom/android/server/backup/BackupManagerServiceInjector;->addRestoredSize(JI)V
+ 
      sget-object v5, Lcom/android/server/backup/BackupManagerService$6;->$SwitchMap$com$android$server$backup$BackupManagerService$RestorePolicy:[I
  
      invoke-virtual/range {v40 .. v40}, Lcom/android/server/backup/BackupManagerService$RestorePolicy;->ordinal()I
***************
*** 4880,4893 ****
  
      iget-object v5, v0, Lcom/android/server/backup/BackupManagerService$PerformAdbRestoreTask;->this$0:Lcom/android/server/backup/BackupManagerService;
  
!     # getter for: Lcom/android/server/backup/BackupManagerService;->mPackageManager:Landroid/content/pm/PackageManager;
!     invoke-static {v5}, Lcom/android/server/backup/BackupManagerService;->access$400(Lcom/android/server/backup/BackupManagerService;)Landroid/content/pm/PackageManager;
  
!     move-result-object v5
  
!     const/4 v7, 0x0
  
!     invoke-virtual {v5, v6, v7}, Landroid/content/pm/PackageManager;->getApplicationInfo(Ljava/lang/String;I)Landroid/content/pm/ApplicationInfo;
  
      move-result-object v5
  
--- 4910,4926 ----
  
      iget-object v5, v0, Lcom/android/server/backup/BackupManagerService$PerformAdbRestoreTask;->this$0:Lcom/android/server/backup/BackupManagerService;
  
!     iget-object v5, v5, Lcom/android/server/backup/BackupManagerService;->mContext:Landroid/content/Context;
  
!     move-object/from16 v0, p0
  
!     iget-object v7, v0, Lcom/android/server/backup/BackupManagerService$PerformAdbRestoreTask;->mInputFile:Landroid/os/ParcelFileDescriptor;
  
!     invoke-virtual {v7}, Landroid/os/ParcelFileDescriptor;->getFd()I
! 
!     move-result v7
! 
!     invoke-static {v5, v6, v7}, Lcom/android/server/backup/BackupManagerServiceInjector;->getApplicationInfo(Landroid/content/Context;Ljava/lang/String;I)Landroid/content/pm/ApplicationInfo;
  
      move-result-object v5
  
***************
*** 6383,6388 ****
      const-string v22, "Invalid restore data; aborting."
  
      invoke-static/range {v21 .. v22}, Landroid/util/Slog;->w(Ljava/lang/String;Ljava/lang/String;)I
      :try_end_8
      .catch Ljava/io/IOException; {:try_start_8 .. :try_end_8} :catch_1
      .catchall {:try_start_8 .. :try_end_8} :catchall_2
--- 6473,6492 ----
      const-string v22, "Invalid restore data; aborting."
  
      invoke-static/range {v21 .. v22}, Landroid/util/Slog;->w(Ljava/lang/String;Ljava/lang/String;)I
+ 
+     const/16 v21, 0x1
+ 
+     move-object/from16 v0, p0
+ 
+     iget-object v0, v0, Lcom/android/server/backup/BackupManagerService$PerformAdbRestoreTask;->mInputFile:Landroid/os/ParcelFileDescriptor;
+ 
+     move-object/from16 v22, v0
+ 
+     invoke-virtual/range {v22 .. v22}, Landroid/os/ParcelFileDescriptor;->getFd()I
+ 
+     move-result v22
+ 
+     invoke-static/range {v21 .. v22}, Lcom/android/server/backup/BackupManagerServiceInjector;->errorOccur(II)V
      :try_end_8
      .catch Ljava/io/IOException; {:try_start_8 .. :try_end_8} :catch_1
      .catchall {:try_start_8 .. :try_end_8} :catchall_2
